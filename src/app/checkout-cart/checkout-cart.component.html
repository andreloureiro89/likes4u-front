<div class="container my-5" id="checkout-cart">
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title d-flex align-items-center gap-2 mb-0">
                <i class="bi bi-cart3"></i>
                Carrinho
            </h5>
        </div>
    </div>

    <!-- loading -->
    <div class="text-center py-5" *ngIf="loading">
        <div class="spinner-grow text-warning me-2" style="width:1.5rem;height:1.5rem" role="status"></div>
        <div class="spinner-grow text-warning me-2" style="width:1.5rem;height:1.5rem" role="status"></div>
        <div class="spinner-grow text-warning" style="width:1.5rem;height:1.5rem" role="status"></div>
    </div>

    <!-- vazio -->
    <div class="card shadow-sm mt-3 p-2" *ngIf="!loading && orders.length === 0">
        <div class="card-body text-center text-muted">
            <div class="mb-2" style="font-size:2rem">üõí</div>
            O teu carrinho est√° vazio.
            <div class="small">Adiciona servi√ßos na pragina principal.</div>
        </div>
    </div>

    <!-- lista -->
    <div class="mt-3" *ngIf="!loading && orders.length > 0">
        <div class="card shadow-sm mb-3 p-2" *ngFor="let o of orders; trackBy: trackById">


            <!-- Dentro do *ngFor="let o of orders; trackBy: trackById" -->
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">

                <!-- Lado esquerdo: info -->
                <div class="text-start">
                    <div class="small text-muted mb-1">
                        <strong>{{ serviceLabel(o.service) }}</strong> ¬∑ {{ categoryLabel(o.categoria) }}  - {{ o.total | number:'1.2-2' }} ‚Ç¨
                    </div>

                    <!-- modo leitura -->
                    <ng-container *ngIf="editingId !== o.id; else editFields">
                        <span class="me-3">
                            Quantidade: <strong>{{ o.quantity }}</strong>
                        </span>
                        <span class="me-3" *ngIf="commentsCount(o) > 0">
                            Coment√°rios: <strong>{{ commentsCount(o) }}</strong>
                        </span>
                        <span class="d-block d-md-inline mt-1 mt-md-0 text-muted small">
                            <span class="text-break">{{ shortUrl(o.link) }}</span>
                        </span>
                    </ng-container>

                    <!-- modo edi√ß√£o -->
                    <ng-template #editFields>
                        <div class="row g-2 align-items-center">
                            <div class="col-12 col-md-8">
                                <label class="form-label small mb-1">Link</label>
                                <input type="url" class="form-control form-control-sm" [(ngModel)]="editModel.link" readonly>
                            </div>

                            <!-- Quantidade: N√ÉO mostrar para comments premium -->
                            <div class="col-6 col-md-4"
                                *ngIf="editModel?.service !== 'comments' || editModel?.categoria !== '554'">
                            <label class="form-label small mb-1">Quantidade</label>
                            <div class="input-group input-group-sm">
                                <button class="btn btn-outline-secondary" type="button" (click)="decQty()" [disabled]="!editModel">‚àí</button>
                                <input type="text" class="form-control text-center" [value]="editModel?.quantity" readonly>
                                <button class="btn btn-outline-secondary" type="button" (click)="incQty()" [disabled]="!editModel">+</button>
                            </div>
                            </div>
                        </div>

                        <!-- AQUI: textarea s√≥ quando o servi√ßo for 'comments' -->
                        <div class="mt-2" *ngIf="editModel?.service === 'comments' && editModel?.categoria == '554'">
                            <label class="form-label small mb-1">Coment√°rios (1 por linha)</label>
                            <textarea class="form-control form-control-sm" rows="6"
                                [(ngModel)]="commentsAsString"></textarea>

                            <div class="form-text" *ngIf="editModel?.categoria === '554'">
                                Para a categoria PREMIUM nos coment√°rios: m√≠nimo 2 e m√°ximo 20 (n√∫meros pares). A lista deve ter a mesma
                                quantidade escolhida.
                            </div>
                        </div>
                    </ng-template>
                </div>

                <!-- Lado direito: bot√µes -->
                <div class="d-flex align-items-center gap-2">
                    <button *ngIf="editingId !== o.id" class="btn btn-outline-primary btn-sm" (click)="editar(o)"
                        title="Editar">
                        <i class="bi bi-pencil"></i> Editar
                    </button>

                    <button *ngIf="editingId === o.id" class="btn btn-primary btn-sm" (click)="guardarEdicao()"
                        title="Guardar">
                        <i class="bi bi-check2"></i> Guardar
                    </button>

                    <button *ngIf="editingId === o.id" class="btn btn-outline-secondary btn-sm"
                        (click)="cancelarEdicao()" title="Cancelar">
                        <i class="bi bi-x-lg"></i> Cancelar
                    </button>

                    <button class="btn btn-outline-danger btn-sm" (click)="remove(o)" title="Remover">
                        <i class="bi bi-trash3"></i> Remover
                    </button>
                </div>
            </div>

            <!-- Pr√©-visualiza√ß√£o dos coment√°rios (modo leitura) -->
            <div *ngIf="commentsCount(o) > 0 && editingId !== o.id" class="mt-3">
                <div class="small text-muted">Pr√©-visualiza√ß√£o dos coment√°rios:</div>
                <ul class="list-unstyled small bg-light rounded p-2 mb-0" style="max-height: 140px; overflow: auto;">
                    <li *ngFor="let c of o.comments">{{ c }}</li>
                </ul>
            </div>
        </div>

        <!-- a√ß√µes finais -->
        <div class="d-flex flex-column flex-md-row justify-content-between gap-2 mt-4">
            <div class="text-muted small">
                Itens no carrinho: <strong>{{ orders.length }}</strong>
                (Total unidades: <strong>{{ totalQuantity }}</strong>)
                <div style="font-weight: 900; font-size: larger;">
                    Total: <strong>{{ totalCartValue | currency:'EUR':'symbol' }}</strong>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" (click)="refresh('atualizar')">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar
                </button>
                <button class="btn btn-danger" (click)="clenCheckOutCart()">
                    <i class="bi bi-cart-x"></i> Esvaziar carrinho
                </button>
                <button class="btn btn-primary">
                    <i class="bi bi-credit-card-fill"></i> Finalizar compra
                </button>
            </div>
        </div>
    </div>
</div>
<app-modal-popup #confirm></app-modal-popup>