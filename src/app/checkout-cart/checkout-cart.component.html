<div class="container my-5" id="checkout-cart">
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title d-flex align-items-center gap-2 mb-0">
                <i class="bi bi-cart3"></i>
                Carrinho
            </h5>
        </div>
    </div>

    <!-- loading -->
    <div class="text-center py-5" *ngIf="loading">
        <div class="spinner-grow text-warning me-2" style="width:1.5rem;height:1.5rem" role="status"></div>
        <div class="spinner-grow text-warning me-2" style="width:1.5rem;height:1.5rem" role="status"></div>
        <div class="spinner-grow text-warning" style="width:1.5rem;height:1.5rem" role="status"></div>
    </div>

    <!-- vazio -->
    <div class="card shadow-sm mt-3 p-2" *ngIf="!loading && orders.length === 0">
        <div class="card-body text-center text-muted">
            <div class="mb-2" style="font-size:2rem">üõí</div>
            O teu carrinho est√° vazio.
            <div class="small">Adiciona servi√ßos na pragina principal.</div>
        </div>
    </div>

    <!-- lista -->
    <div class="mt-3" *ngIf="!loading && orders.length > 0">
        <div class="card shadow-sm mb-3 p-2" *ngFor="let o of orders; trackBy: trackById">


            <!-- Dentro do *ngFor="let o of orders; trackBy: trackById" -->
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">

                <!-- Lado esquerdo: info -->
                <div class="text-start">
                    <div class="small text-muted mb-1">
                        <strong>{{ serviceLabel(o.service) }}</strong> ¬∑ {{ categoryLabel(o.categoria) }} - {{ o.total |
                        number:'1.2-2' }} ‚Ç¨
                    </div>

                    <!-- modo leitura -->
                    <ng-container *ngIf="editingId !== o.id; else editFields">
                        <span class="me-3">
                            Quantidade: <strong>{{ o.quantity }}</strong>
                        </span>
                        <span class="me-3" *ngIf="commentsCount(o) > 0">
                            Coment√°rios: <strong>{{ commentsCount(o) }}</strong>
                        </span>
                        <span class="d-block d-md-inline mt-1 mt-md-0 text-muted small">
                            <span class="text-break">{{ shortUrl(o.link) }}</span>
                        </span>
                    </ng-container>

                    <!-- modo edi√ß√£o -->
                    <ng-template #editFields>
                        <div class="row g-2 align-items-center">
                            <div class="col-12 col-md-8">
                                <label class="form-label small mb-1">Link</label>
                                <input type="url" class="form-control form-control-sm" [(ngModel)]="editModel.link"
                                    readonly>
                            </div>

                            <!-- Quantidade: N√ÉO mostrar para comments premium -->
                            <div class="col-6 col-md-4"
                                *ngIf="editModel?.service !== 'comments' || editModel?.categoria !== '554'">
                                <label class="form-label small mb-1">Quantidade</label>
                                <div class="input-group input-group-sm">
                                    <button class="btn btn-outline-secondary" type="button" (click)="decQty()"
                                        [disabled]="!editModel">‚àí</button>
                                    <input type="text" class="form-control text-center" [value]="editModel?.quantity"
                                        readonly>
                                    <button class="btn btn-outline-secondary" type="button" (click)="incQty()"
                                        [disabled]="!editModel">+</button>
                                </div>
                            </div>
                        </div>

                        <!-- AQUI: textarea s√≥ quando o servi√ßo for 'comments' -->
                        <div class="mt-2" *ngIf="editModel?.service === 'comments' && editModel?.categoria == '554'">
                            <label class="form-label small mb-1">Coment√°rios (1 por linha)</label>
                            <textarea class="form-control form-control-sm" rows="6"
                                [(ngModel)]="commentsAsString"></textarea>

                            <div class="form-text" *ngIf="editModel?.categoria === '554'">
                                Para a categoria PREMIUM nos coment√°rios: m√≠nimo 2 e m√°ximo 20 (n√∫meros pares). A lista
                                deve ter a mesma
                                quantidade escolhida.
                            </div>
                        </div>
                    </ng-template>
                </div>

                <!-- Lado direito: bot√µes -->
                <div class="d-flex align-items-center gap-2">
                    <button *ngIf="editingId !== o.id" class="btn btn-outline-primary btn-sm" (click)="editar(o)"
                        title="Editar">
                        <i class="bi bi-pencil"></i> Editar
                    </button>

                    <button *ngIf="editingId === o.id" class="btn btn-primary btn-sm" (click)="guardarEdicao()"
                        title="Guardar">
                        <i class="bi bi-check2"></i> Guardar
                    </button>

                    <button *ngIf="editingId === o.id" class="btn btn-outline-secondary btn-sm"
                        (click)="cancelarEdicao()" title="Cancelar">
                        <i class="bi bi-x-lg"></i> Cancelar
                    </button>

                    <button class="btn btn-outline-danger btn-sm" (click)="remove(o)" title="Remover">
                        <i class="bi bi-trash3"></i> Remover
                    </button>
                </div>
            </div>

            <!-- Pr√©-visualiza√ß√£o dos coment√°rios (modo leitura) -->
            <div *ngIf="commentsCount(o) > 0 && editingId !== o.id" class="mt-3">
                <div class="small text-muted">Pr√©-visualiza√ß√£o dos coment√°rios:</div>
                <ul class="list-unstyled small bg-light rounded p-2 mb-0" style="max-height: 140px; overflow: auto;">
                    <li *ngFor="let c of o.comments">{{ c }}</li>
                </ul>
            </div>
        </div>

        <!-- a√ß√µes finais -->
        <div class="d-flex flex-column flex-md-row justify-content-between gap-2 mt-4">
            <div class="text-muted small">
                Itens no carrinho: <strong>{{ orders.length }}</strong>
                (Total unidades: <strong>{{ totalQuantity }}</strong>)
                <div style="font-weight: 900; font-size: larger;">
                    Total: <strong>{{ totalCartValue | currency:'EUR':'symbol' }}</strong>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" (click)="refresh('atualizar')">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar carrinho
                </button>
                <button class="btn btn-danger" (click)="clenCheckOutCart()">
                    <i class="bi bi-cart-x"></i> Esvaziar carrinho
                </button>
                <button class="btn btn-primary" (click)="showPayments = !showPayments">
                    <i class="bi bi-credit-card-fill"></i> Finalizar compra
                </button>
            </div>
        </div>
    </div>
    <div class="mt-3" *ngIf="showPayments">
        <div class="row g-2 text-center">

            <!-- MB WAY -->
            <div class="col-4">
                <div class="card p-2 shadow-sm small text-center" (click)="selectPayment('mbway')"
                    style="cursor:pointer">
                    <i class="bi bi-credit-card-2-back-fill" style="font-size: xx-large;"></i>MB WAY
                </div>
            </div>

            <!-- Multibanco -->
            <div class="col-4">
                <div class="card p-2 shadow-sm small" (click)="selectPayment('multibanco')" style="cursor:pointer">
                    <i class="bi bi-credit-card-2-front" style="font-size: xx-large;"></i>Multibanco
                </div>
            </div>

            <!-- Cart√£o -->
            <div class="col-4">
                <div class="card p-2 shadow-sm small" (click)="selectPayment('card')" style="cursor:pointer">
                    <i class="bi bi-person-vcard" style="font-size: xx-large;"></i>Cart√£o de Credito
                </div>
            </div>
        </div>
    </div>

    <form *ngIf="selectedPayment === 'mbway'" (ngSubmit)="confirmMbWay()" #mbForm="ngForm" novalidate class="row g-3">

        <!-- N√∫mero de telem√≥vel -->
        <div class="col-12 col-md-6">
            <label class="form-label small">Telem√≥vel (MB WAY)</label>
            <input type="tel" name="phone" class="form-control" [(ngModel)]="mbw.phone" required pattern="^9\d{8}$"
                inputmode="numeric" placeholder="9XXXXXXXX" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            <div class="invalid-feedback d-block" *ngIf="mbForm.submitted && !mbForm.controls['phone']?.valid">
                Introduz um n¬∫ v√°lido (tem de come√ßar por 9 e ter exatamente 9 d√≠gitos).
            </div>
        </div>

        <!-- Bot√µes -->
        <div class="col-12 d-flex gap-2">
            <button type="submit" class="btn btn-primary" [disabled]="mbBusy || !mbForm.valid">
                <span *ngIf="mbBusy" class="spinner-border spinner-border-sm me-1"></span>
                Confirmar pedido ‚Äì {{ totalCartValue | currency:'EUR':'symbol' }}
            </button>
            <button type="button" class="btn btn-outline-secondary" (click)="cancelPayment()">Cancelar</button>
        </div>
    </form>

    <!-- MULTIBANCO -->
    <form *ngIf="selectedPayment === 'multibanco'" (ngSubmit)="confirmMultibanco()" #mbRefForm="ngForm" novalidate
        class="row g-3">

        <!-- Nome (opcional) -->
        <div class="col-12 col-md-6">
            <label class="form-label small">Nome (opcional)</label>
            <input type="text" name="name" class="form-control" [(ngModel)]="mbRef.name" maxlength="120"
                placeholder="Nome do Cliente">
        </div>

        <!-- NIF (opcional) -->
        <div class="col-12 col-md-6">
            <label class="form-label small">NIF (opcional)</label>
            <input type="text" name="nif" class="form-control" [(ngModel)]="mbRef.nif" pattern="^[1235689]\d{8}$"
                inputmode="numeric" placeholder="9 d√≠gitos (se aplic√°vel)">
            <div class="invalid-feedback d-block" *ngIf="mbRefForm.submitted && mbRefForm.controls['nif']?.invalid">
                NIF inv√°lido (9 d√≠gitos, come√ßa por 1,2,3,5,6,8 ou 9).
            </div>
        </div>

        <!-- Email (obrigat√≥rio) -->
        <div class="col-12 col-md-6">
            <label class="form-label small">Email</label>
            <input type="email" name="email" class="form-control" [(ngModel)]="mbRef.email" required
                pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" placeholder="exemplo@dominio.com">
            <div class="invalid-feedback d-block" *ngIf="mbRefForm.submitted && mbRefForm.controls['email']?.invalid">
                Email inv√°lido.
            </div>
        </div>

        <!-- Valor -->
        <div class="col-12 col-md-6">
            <label class="form-label small">Valor</label>
            <input class="form-control" [value]="totalCartValue | currency:'EUR':'symbol'" readonly>
        </div>

        <!-- Bot√µes -->
        <div class="col-12 d-flex gap-2">
            <button type="submit" class="btn btn-primary" [disabled]="mbRefBusy || !mbRefForm.valid">
                <span *ngIf="mbRefBusy" class="spinner-border spinner-border-sm me-1"></span>
                Gerar refer√™ncia ‚Äì {{ totalCartValue | currency:'EUR':'symbol' }}
            </button>
            <button type="button" class="btn btn-outline-secondary" (click)="cancelPayment()">Cancelar</button>
        </div>
    </form>

    <!-- CART√ÉO DE CR√âDITO -->
    <form *ngIf="selectedPayment === 'card'" (ngSubmit)="confirmCard()" #ccForm="ngForm" novalidate class="row g-3">

        <!-- Nome no cart√£o -->
        <div class="col-12 col-md-6">
            <label class="form-label small">Nome no cart√£o</label>
            <input type="text" name="name" class="form-control" [(ngModel)]="cc.name" required>
            <div class="invalid-feedback d-block" *ngIf="ccForm.submitted && !ccForm.controls['name']?.valid">
                Introduz o nome do cart√£o.
            </div>
        </div>

        <!-- N√∫mero do cart√£o -->
        <div class="col-12 col-md-6">
            <label class="form-label small">N√∫mero do cart√£o</label>
            <input type="text" name="number" class="form-control" [(ngModel)]="cc.number" required
                pattern="^[0-9]{13,19}$" inputmode="numeric" placeholder="1234 5678 9012 3456">
            <div class="invalid-feedback d-block" *ngIf="ccForm.submitted && !ccForm.controls['number']?.valid">
                Introduz um n√∫mero de cart√£o v√°lido (13 a 19 d√≠gitos).
            </div>
        </div>

        <!-- Validade -->
        <div class="col-6 col-md-3">
            <label class="form-label small">Validade (MM/AA)</label>
            <input type="text" name="exp" class="form-control" [(ngModel)]="cc.exp" required
                pattern="^(0[1-9]|1[0-2])\/\d{2}$" placeholder="MM/AA">
            <div class="invalid-feedback d-block" *ngIf="ccForm.submitted && !ccForm.controls['exp']?.valid">
                Introduz validade no formato MM/AA.
            </div>
        </div>

        <!-- CVC -->
        <div class="col-6 col-md-3">
            <label class="form-label small">CVC</label>
            <input type="text" name="cvc" class="form-control" [(ngModel)]="cc.cvc" required pattern="^[0-9]{3,4}$"
                inputmode="numeric" placeholder="123">
            <div class="invalid-feedback d-block" *ngIf="ccForm.submitted && !ccForm.controls['cvc']?.valid">
                Introduz o c√≥digo de 3 ou 4 d√≠gitos.
            </div>
        </div>

        <!-- Email -->
        <div class="col-12 col-md-6">
            <label class="form-label small">Email</label>
            <input type="email" name="email" class="form-control" [(ngModel)]="cc.email" required
                pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" placeholder="exemplo@email.com">
            <div class="invalid-feedback d-block" *ngIf="ccForm.submitted && !ccForm.controls['email']?.valid">
                Introduz um email v√°lido.
            </div>
        </div>

        <!-- Bot√µes -->
        <div class="col-12 d-flex gap-2">
            <button type="submit" class="btn btn-primary" [disabled]="ccBusy || !ccForm.valid">
                <span *ngIf="ccBusy" class="spinner-border spinner-border-sm me-1"></span>
                Confirmar pedido ‚Äì {{ totalCartValue | currency:'EUR':'symbol' }}
            </button>
            <button type="button" class="btn btn-outline-secondary" (click)="cancelPayment()">Cancelar</button>
        </div>
    </form>

</div>
<app-modal-popup #confirm></app-modal-popup>